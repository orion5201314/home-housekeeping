import{_ as e}from"./u-icon.0c807563.js";import{o as t,c as s,w as i,e as l,R as a,p as o,t as r,x as n,F as u,b as d,n as p,a as h,i as c,af as f,a8 as m,z as g,ag as y,D as v,ae as w,ah as b,r as x,d as S,y as k,T as C,S as $,f as _,g as B,j as T,s as U,L as F,l as I}from"./index.ceec0680.js";import{_ as N}from"./plugin-vue_export-helper.21dcd24c.js";import{t as O}from"./util.52efa071.js";var P=N({name:"u-line-progress",props:{round:{type:Boolean,default:!0},type:{type:String,default:""},activeColor:{type:String,default:"#19be6b"},inactiveColor:{type:String,default:"#ececec"},percent:{type:Number,default:0},showPercent:{type:Boolean,default:!0},height:{type:[Number,String],default:28},striped:{type:Boolean,default:!1},stripedActive:{type:Boolean,default:!1}},data:()=>({}),computed:{progressStyle(){let e={};return e.width=this.percent+"%",this.activeColor&&(e.backgroundColor=this.activeColor),e}},methods:{}},[["render",function(e,f,m,g,y,v){const w=c;return t(),s(w,{class:"u-progress",style:h({borderRadius:m.round?"100rpx":0,height:m.height+"rpx",backgroundColor:m.inactiveColor})},{default:i((()=>[l(w,{class:p([[m.type?`u-type-${m.type}-bg`:"",m.striped?"u-striped":"",m.striped&&m.stripedActive?"u-striped-active":""],"u-active"]),style:h([v.progressStyle])},{default:i((()=>[e.$slots.default||e.$slots.$default?a(e.$slots,"default",{key:0},void 0,!0):m.showPercent?(t(),o(u,{key:1},[r(n(m.percent+"%"),1)],64)):d("v-if",!0)])),_:3},8,["class","style"])])),_:3},8,["style"])}],["__scopeId","data-v-08e663ba"]]);var z=N({name:"u-upload",emits:["update:file-list","on-oversize","on-list-change","on-preview","on-remove","on-success","on-change","on-error","on-progress","on-uploaded","on-choose-complete","on-choose-fail"],props:{showUploadList:{type:Boolean,default:!0},action:{type:String,default:""},maxCount:{type:[String,Number],default:52},showProgress:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},imageMode:{type:String,default:"aspectFill"},header:{type:Object,default:()=>({})},formData:{type:Object,default:()=>({})},name:{type:String,default:"file"},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},previewFullImage:{type:Boolean,default:!0},multiple:{type:Boolean,default:!0},deletable:{type:Boolean,default:!0},maxSize:{type:[String,Number],default:Number.MAX_VALUE},fileList:{type:Array,default:()=>[]},uploadText:{type:String,default:"选择图片"},autoUpload:{type:Boolean,default:!0},showTips:{type:Boolean,default:!0},customBtn:{type:Boolean,default:!1},width:{type:[String,Number],default:200},height:{type:[String,Number],default:200},delBgColor:{type:String,default:"#fa3534"},delColor:{type:String,default:"#ffffff"},delIcon:{type:String,default:"close"},successIcon:{type:String,default:"checkbox-mark"},successColor:{type:String,default:"#ffffff"},toJson:{type:Boolean,default:!0},beforeUpload:{type:Function,default:null},beforeRemove:{type:Function,default:null},limitType:{type:Array,default:()=>["png","jpg","jpeg","webp","gif","image"]},index:{type:[Number,String],default:""}},mounted(){},data:()=>({lists:[],isInCount:!0,uploading:!1}),watch:{fileList:{immediate:!0,handler(e){let t=JSON.parse(JSON.stringify(this.lists));e.map((e=>{t.some((t=>t.url==e.url))||t.push({url:e.url,error:!1,progress:100})})),this.lists=JSON.parse(JSON.stringify(t))}},lists:{deep:!0,handler(e){this.$emit("update:file-list",e),this.$emit("on-list-change",e,this.index)}}},methods:{clear(){this.lists=[]},reUpload(){this.uploadFile()},selectFile(){let e=this;if(e.disabled)return;const{name:t="",maxCount:s,multiple:i,maxSize:l,sizeType:a,camera:o,compressed:r,maxDuration:n,sourceType:u}=e;let d=null,p=JSON.parse(JSON.stringify(e.lists));const h=s-p.length;d=new Promise(((e,t)=>{f({count:i?h>9?9:h:1,sourceType:u,sizeType:a,success:e,fail:t})})),d.then((t=>{let a=e.lists.length;t.tempFiles.map(((t,a)=>{if(e.checkFileExt(t)&&(i||!(a>=1)))if(t.size>l)e.$emit("on-oversize",t,e.lists,e.index),e.showToast("超出允许的文件大小");else{if(s<=p.length)return e.$emit("on-exceed",t,e.lists,e.index),void e.showToast("超出最大允许的文件个数");p.push({url:t.path,progress:0,error:!1,file:t})}})),this.deepClone(p,e.lists),e.$emit("on-choose-complete",e.lists,e.index),e.autoUpload&&e.uploadFile(a)})).catch((t=>{e.$emit("on-choose-fail",t)}))},showToast(e,t=!1){(this.showTips||t)&&m({title:e,icon:"none"})},upload(){this.uploadFile()},retry(e){this.lists[e].progress=0,this.lists[e].error=!1,this.lists[e].response=null,g({title:"重新上传"}),this.uploadFile(e)},async uploadFile(e=0){if(this.disabled)return;if(this.uploading)return;if(e>=this.lists.length)return void this.$emit("on-uploaded",this.lists,this.index);if(100==this.lists[e].progress)return void(0==this.autoUpload&&this.uploadFile(e+1));if(this.beforeUpload&&"function"==typeof this.beforeUpload){let t=this.beforeUpload.bind(this.$u.$parent.call(this))(e,this.lists);if(t&&"function"==typeof t.then)await t.then((e=>{})).catch((t=>this.uploadFile(e+1)));else if(!1===t)return this.uploadFile(e+1)}if(!this.action)return void this.showToast("请配置上传地址",!0);this.lists[e].error=!1,this.uploading=!0;y({url:this.action,filePath:this.lists[e].url,name:this.name,formData:this.formData,header:this.header,success:t=>{let s=this.toJson&&this.$u.test.jsonString(t.data)?JSON.parse(t.data):t.data;[200,201,204].includes(t.statusCode)?(this.lists[e].response=s,this.lists[e].progress=100,this.lists[e].error=!1,this.$emit("on-success",s,e,this.lists,this.index)):this.uploadError(e,s)},fail:t=>{this.uploadError(e,t)},complete:t=>{v(),this.uploading=!1,this.uploadFile(e+1),this.$emit("on-change",t,e,this.lists,this.index)}}).onProgressUpdate((t=>{t.progress>0&&(this.lists[e].progress=t.progress,this.$emit("on-progress",t,e,this.lists,this.index))}))},uploadError(e,t){this.lists[e].progress=0,this.lists[e].error=!0,this.lists[e].response=null,this.$emit("on-error",t,e,this.lists,this.index),this.showToast("上传失败，请重试")},deleteItem(e){w({title:"提示",content:"您确定要删除此项吗？",success:async t=>{if(t.confirm)if(this.beforeRemove&&"function"==typeof this.beforeRemove){let t=this.beforeRemove.bind(this.$u.$parent.call(this))(e,this.lists);t&&"function"==typeof t.then?await t.then((t=>{this.handlerDeleteItem(e)})).catch((e=>{this.showToast("已终止移除")})):!1===t?this.showToast("已终止移除"):this.handlerDeleteItem(e)}else this.handlerDeleteItem(e)}})},handlerDeleteItem(e){this.lists[e].process<100&&this.lists[e].process>0&&void 0!==this.lists[e].uploadTask&&this.lists[e].uploadTask.abort(),this.lists.splice(e,1),this.$forceUpdate(),this.$emit("on-remove",e,this.lists,this.index)},remove(e){e>=0&&e<this.lists.length&&this.lists.splice(e,1)},doPreviewImage(e,t){if(!this.previewFullImage)return void this.$emit("on-preview",e,this.lists,this.index);const s=this.lists.map((e=>e.url||e.path));b({urls:s,current:e,success:()=>{this.$emit("on-preview",e,this.lists,this.index)},fail:()=>{m({title:"预览图片失败",icon:"none"})}})},checkFileExt(e){let t=!1,s="";return s=e.name.replace(/.+\./,"").toLowerCase(),t=this.limitType.some((e=>e.toLowerCase()===s)),t||this.showToast(`不允许选择${s}格式的文件`),t},deepClone(e,t){for(let s in e){const i=e[s];Array.isArray(i)?(t[s]=[],this.deepClone(i,t[s])):null!==i&&"object"==typeof i?(t[s]={},this.deepClone(i,t[s])):t[s]=i}}}},[["render",function(p,f,m,g,y,v){const w=x(S("u-icon"),e),b=c,_=x(S("u-line-progress"),P),B=$;return m.disabled?d("v-if",!0):(t(),s(b,{key:0,class:"u-upload"},{default:i((()=>[m.showUploadList?(t(!0),o(u,{key:0},k(y.lists,((e,a)=>(t(),s(b,{class:"u-list-item u-preview-wrap",key:a,style:h({width:p.$u.addUnit(m.width),height:p.$u.addUnit(m.height)})},{default:i((()=>[m.deletable?(t(),s(b,{key:0,class:"u-delete-icon",onClick:C((e=>v.deleteItem(a)),["stop"]),style:h({background:m.delBgColor})},{default:i((()=>[l(w,{class:"u-icon",name:m.delIcon,size:"20",color:m.delColor},null,8,["name","color"])])),_:2},1032,["onClick","style"])):d("v-if",!0),d(' <view\r\n\t\t\t\tv-if="item.progress >= 100"\r\n\t\t\t\tclass="u-success-icon"\r\n\t\t\t>\r\n\t\t\t\t<u-icon class="u-icon" :name="successIcon" size="20" :color="successColor"></u-icon>\r\n\t\t\t</view> '),m.showProgress&&e.progress>0&&!e.error&&e.progress<100?(t(),s(_,{key:1,"show-percent":!1,height:"16",class:"u-progress",percent:e.progress},null,8,["percent"])):d("v-if",!0),e.error?(t(),s(b,{key:2,onClick:C((e=>v.retry(a)),["stop"]),class:"u-error-btn"},{default:i((()=>[r("点击重试")])),_:2},1032,["onClick"])):d("v-if",!0),e.isImage?d("v-if",!0):(t(),s(B,{key:3,onClick:C((t=>v.doPreviewImage(e.url||e.path,a)),["stop"]),class:"u-preview-image",src:e.url||e.path,mode:m.imageMode},null,8,["onClick","src","mode"]))])),_:2},1032,["style"])))),128)):d("v-if",!0),a(p.$slots,"file",{file:y.lists},void 0,!0),m.maxCount>y.lists.length?(t(),s(b,{key:1,style:{display:"inline-block"},onClick:v.selectFile},{default:i((()=>[a(p.$slots,"addBtn",{},void 0,!0),m.customBtn?d("v-if",!0):(t(),s(b,{key:0,class:"u-list-item u-add-wrap","hover-class":"u-add-wrap__hover","hover-stay-time":"150",style:h({width:p.$u.addUnit(m.width),height:p.$u.addUnit(m.height)})},{default:i((()=>[l(w,{name:"plus",class:"u-add-btn",size:"40"}),l(b,{class:"u-add-tips"},{default:i((()=>[r(n(m.uploadText),1)])),_:1})])),_:1},8,["style"]))])),_:3},8,["onClick"])):d("v-if",!0)])),_:3}))}],["__scopeId","data-v-210cc5e0"]]);const j={version:"2.1.1",baseUrl:"/",urlPrefix:"staffapi",timeout:6e4};var J=N(_({__name:"index",props:{mutiple:{type:Boolean,default:!1},maxUpload:{default:1},width:{default:160},height:{default:160},deletable:{type:Boolean,default:!0},tips:{default:"上传图片"},showProgress:{type:Boolean,default:!1},modelValue:{default:null},imageMode:{default:"aspectFill"},customBtn:{type:Boolean,default:!0}},emits:["update:modelValue"],setup(a,{emit:o}){const u=a,p=B(),f=T(""),m=T(""),g=T([]),y=U(),v=e=>{if(O(JSON.parse(e.data).msg),1==JSON.parse(e.data).code){g.value.push({url:JSON.parse(e.data).data.uri});let t=[];u.mutiple?g.value.forEach(((e,s)=>{t.push(e.url)})):t=g.value[0].url,o("update:modelValue",t)}},w=(e,t,s,i)=>{y.value.remove(t)},b=e=>{g.value.splice(e,1);let t=[];u.mutiple?g.value.forEach(((e,s)=>{t.push(e.url)})):t=void 0,o("update:modelValue",t)};return F((()=>{f.value=`/${j.urlPrefix}/Upload/image`,m.value=p.token})),I((()=>u.modelValue),(e=>{u.modelValue&&(u.mutiple?u.modelValue.forEach(((e,t)=>{g.value.push({url:e})})):g.value.push({url:u.modelValue}))}),{immediate:!0}),(o,u)=>{const p=x(S("u-icon"),e),k=c,C=x(S("u-upload"),z);return t(),s(k,{class:"uploader-container flex wrap"},{default:i((()=>[l(C,{onOnChange:v,action:f.value,header:{token:m.value,version:"1.0.0"},deletable:a.deletable,"max-count":a.maxUpload,showProgress:a.showProgress,onOnRemove:b,multiple:a.mutiple,"custom-btn":a.customBtn,width:a.width,height:a.height,ref_key:"uploadRef",ref:y,"file-list":g.value,"image-mode":a.imageMode,onOnError:w},{addBtn:i((()=>[a.customBtn?(t(),s(k,{key:0,class:"uplader-upload u-flex justify-center",style:h({width:a.width+"rpx",height:a.height+"rpx"}),"hover-class":"slot-btn__hover","hover-stay-time":"150"},{default:i((()=>[l(k,{class:"text-center text-[#bbb]"},{default:i((()=>[l(p,{size:"48",color:"#dcdee0",name:"camera"}),l(k,{class:"xs mt-[10rpx]"},{default:i((()=>[r(n(g.value.length>=1?g.value.length+"/"+a.maxUpload:a.tips),1)])),_:1})])),_:1})])),_:1},8,["style"])):d("v-if",!0)])),_:1},8,["action","header","deletable","max-count","showProgress","multiple","custom-btn","width","height","file-list","image-mode"])])),_:1})}}}),[["__scopeId","data-v-e220bfd8"]]);export{z as _,j as c,J as u};
